{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Your Transactions</h2>

    <!-- Search -->
    <form method="get" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" name="search" placeholder="Search by type..." value="{{ request.GET.search }}">
            <div class="input-group-append">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </div>
    </form>

    <table class="table table-bordered table-hover">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Parent</th>
                <th>Actions</th>
                <th>Calculate Sum</th>
            </tr>
        </thead>
        <tbody>
            {% for trans in transactions %}
            <tr>
                <td>{{ trans.id }}</td>
                <td>{{ trans.amount }}</td>
                <td>{{ trans.type }}</td>
                <td>{{ trans.parent }}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editTransaction('{{ trans.id }}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTransaction('{{ trans.id }}')">Delete</button>
                </td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="calculateSum('{{ trans.id }}')">Calculate Sum</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-success" onclick="showAddTransactionModal()">Add Transaction</button>
</div>

<div class="mt-3">
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            {% if transactions.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&search={{ request.GET.search }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ transactions.previous_page_number }}&search={{ request.GET.search }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}
            
            {% for i in transactions.paginator.page_range %}
                {% if transactions.number == i %}
                    <li class="page-item active">
                        <a class="page-link" href="?page={{ i }}&search={{ request.GET.search }}">{{ i }}</a>
                    </li>
                {% elif i > transactions.number|add:"-3" and i < transactions.number|add:"3" %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}&search={{ request.GET.search }}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if transactions.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ transactions.next_page_number }}&search={{ request.GET.search }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ transactions.paginator.num_pages }}&search={{ request.GET.search }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- Edit Modal -->
<div class="modal" tabindex="-1" role="dialog" id="editModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Transaction</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Transaction ID: <span id="editTransactionId"></span></p>
                <label for="editAmount">Amount:</label>
                <input type="number" id="editAmount" class="form-control mb-2">
                <label for="editType">Type:</label>
                <input type="text" id="editType" class="form-control mb-2">
                <label for="editParentId">Parent ID (Optional):</label>
                <select id="editParentId" class="form-control mb-2"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitEdit()">Submit</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeEditModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal" tabindex="-1" role="dialog" id="addTransactionModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Transaction</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label for="addAmount">Amount:</label>
                <input type="number" id="addAmount" class="form-control mb-2">
                <label for="addType">Type:</label>
                <input type="text" id="addType" class="form-control mb-2">
                <label for="addParentId">Parent ID (Optional):</label>
                <select id="addParentId" class="form-control mb-2"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitAddTransaction()">Add</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeAddTransactionModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Tree Modal -->
<div class="modal" tabindex="-1" role="dialog" id="transactionTree">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Tree for ID: <span id="transactionTreeId"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="transactionTreeContent">
                <!-- Content will be populated here by the JavaScript function -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeTransactionTreeModal()">Close</button>
            </div>
        </div>
    </div>
</div>


{% csrf_token %}
<script>

    function populateParentIds(excludeId) {
        // excludeId is optional and is used for edit transaction
        let endpoint = '/transactionservice/all_transaction_ids/';  // Default endpoint

        if (excludeId !== undefined) {
            endpoint = `/transactionservice/potential_parents/${excludeId}/`;
}

        fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            const addParentIdSelect = document.getElementById('addParentId');
            const editParentIdSelect = document.getElementById('editParentId');
            
            // Clear previous options
            addParentIdSelect.innerHTML = '<option value="">Select Parent ID</option>';
            editParentIdSelect.innerHTML = '<option value="">Select Parent ID</option>';

            data.forEach(id => {
                if (id !== excludeId) {  // Exclude the current ID for edit
                    addParentIdSelect.innerHTML += `<option value="${id}">${id}</option>`;
                    editParentIdSelect.innerHTML += `<option value="${id}">${id}</option>`;
                }
            });
        });
    }

    // Call this function when the page loads to populate for Add Transaction

    function showAddTransactionModal() {
        populateParentIds();
        document.getElementById("addTransactionModal").style.display = "block";
    }

    function closeAddTransactionModal() {
        document.getElementById("addTransactionModal").style.display = "none";
    }

    function submitAddTransaction() {
        const amountElement = document.getElementById("addAmount");
        const typeElement = document.getElementById("addType");
        const parentElement = document.getElementById("addParentId");
        
        const amount = amountElement ? amountElement.value : null;
        const type = typeElement ? typeElement.value : null;
        const parent = parentElement ? parentElement.value : null;

        if (!amount || !type) {
            alert('Amount and Type fields are mandatory.');
            return;
        }
        
        const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfElement ? csrfElement.value : '';

        if(!csrfToken) {
            alert('CSRF token missing. Cannot proceed.');
            return;
        }

        fetch(`/transactionservice/transaction/`, {
            method: 'POST', 
            body: JSON.stringify({
                amount: amount,
                type: type,
                parent: parent || null  // if parent is empty or null, send null
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if(response.ok) {
                location.reload(); 
            } else {
                alert('Error adding transaction');
            }
        });
    }

    function renderTree(node) {
        let content = `<ul><li>ID: ${node.id}, Amount: ${node.amount}, Type: ${node.type}`;

        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                content += renderTree(child);
            });
        }

        content += `</li></ul>`;
        return content;
    }

    function displayTransactionTree(id) {
        fetch(`/transactionservice/transaction_tree/${id}/`)
        .then(response => response.json())
        .then(data => {
            const treeContentElement = document.getElementById('transactionTreeContent');
            treeContentElement.innerHTML = renderTree(data);  // Nested lists representation

            const treeTitleElement = document.getElementById('transactionTreeId');
            treeTitleElement.textContent = id;

            // Use Bootstrap's modal method to show the modal
            $('#transactionTree').modal('show');
        })
        .catch(error => {
            console.error("Error fetching transaction tree:", error);
            alert("Error fetching the transaction structure.");
        });
    }

    function closeTransactionTreeModal() {
        // Use Bootstrap's modal method to hide the modal
        $('#transactionTree').modal('hide');
    }

    function calculateSum(id) {
        fetch(`/transactionservice/sum/${id}/`)
        .then(response => response.json())
        .then(data => {
            alert(`Sum for Transaction ID ${id}: ${data.sum}`);

            // Display the transaction tree after displaying the sum
            displayTransactionTree(id);
        })
        .catch(error => {
            console.error("Error fetching sum:", error);
            alert("Error fetching sum for the transaction.");
        });
    }

    function deleteTransaction(id) {
        fetch(`/transactionservice/has_dependents/${id}/`)
        .then(response => response.json())
        .then(data => {
            if(data.has_children) {
                const choice = confirm("This transaction has dependent transactions. Do you still want to delete? If you choose OK, the dependent transactions' parent will be set to null or reassigned to the current transaction's parent, based on your preference.");
                
                if (choice) {
                    if(data.parent_id) {
                        const reassignChoice = confirm("Do you want to reassign the child transactions to the current transaction's parent? If you choose Cancel, the child transactions' parent ID will be set to null.");
                        
                        if(reassignChoice) {
                            // Reassign the child transactions to the current transaction's parent
                            reassignChildren(id, data.parent_id);
                        } else {
                            // Set the child transactions' parent ID to null
                            reassignChildren(id, null);
                        }
                    }
                    else {
                        reassignChildren(id, null);
                    }
                    proceedToDelete(id);  // Finally, delete the transaction
                }
            } else {
                const choice = confirm("Are you sure you want to delete this transaction?");
                if(choice) {
                    proceedToDelete(id);
                }
            }
        })
        .catch(error => {
            console.error("Error checking dependent transactions:", error);
            alert("Error checking dependent transactions.");
        });
    }

    function proceedToDelete(id) {
        const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfElement ? csrfElement.value : null;

        if(!csrfToken) {
            alert('CSRF token missing. Cannot proceed.');
            return;
        }

        fetch(`/transactionservice/delete_transaction/${id}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if(response.ok) {
                location.reload();  // Reload the page to see changes
            } else {
                alert('Error deleting transaction');
            }
        })
        .catch(error => {
            console.error("Error deleting transaction:", error);
            alert("Error deleting the transaction.");
        });
    }

    function reassignChildren(transactionId, newParentId) {
        const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfElement ? csrfElement.value : null;

        if(!csrfToken) {
            alert('CSRF token missing. Cannot proceed.');
            return;
        }

        fetch(`/transactionservice/reassign_children/${transactionId}/`, {
            method: 'PUT',
            body: JSON.stringify({
                parent: newParentId
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if(!response.ok) {
                alert('Error reassigning children transactions');
            }
        })
        .catch(error => {
            console.error("Error reassigning children transactions:", error);
            alert("Error reassigning children transactions.");
        });
    }

    function editTransaction(id) {
        document.getElementById("editModal").style.display = "block";
        document.getElementById("editTransactionId").textContent = id;
        populateParentIds(id);  // Populate excluding the current ID
        // Here you can fetch the current data of the transaction if needed

    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }

    function submitEdit() {
        const idElement = document.getElementById("editTransactionId");
        const amountElement = document.getElementById("editAmount");
        const typeElement = document.getElementById("editType");
        const parentElement = document.getElementById("editParentId");
        
        const transactionId = idElement ? idElement.textContent.trim() : null;
        const amount = amountElement ? amountElement.value : null;
        const type = typeElement ? typeElement.value : null;
        const parent = parentElement ? parentElement.value : null;

        if (!transactionId || !amount || !type) {
            alert('Transaction ID, Amount, and Type fields are mandatory.');
            return;
        }
        
        const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfElement ? csrfElement.value : '';

        if(!csrfToken) {
            alert('CSRF token missing. Cannot proceed.');
            return;
        }

        fetch(`/transactionservice/transaction/${transactionId}/`, {
            method: 'PUT',
            body: JSON.stringify({
                amount: amount,
                type: type,
                parent: parent || null  // if parent is empty or null, send null
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if(response.ok) {
                location.reload();  // Reload the page to see changes
            } else {
                alert('Error updating transaction');
            }
        });
    }
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock %}